// static/js/social-media-automation.js

class SocialMediaAutomation {
    constructor() {
        this.apiBase = '/api';
        this.currentUser = 'default_user';
        this.init();
    }

    init() {
        this.setupEventListeners();
    }

    setupEventListeners() {
        document.getElementById('add-content-btn')?.addEventListener('click', () => this.addTrainingContent());
        document.getElementById('generate-content-btn')?.addEventListener('click', () => this.generateContent());
        document.getElementById('market-data-btn')?.addEventListener('click', () => this.loadMarketData());

        // Add listener for A/B test buttons that appear after content generation
        document.getElementById('content-results')?.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('create-ab-test-btn')) {
                this.handleCreateABTest(e.target);
            }
        });
    }

    // --- TRAINING VOICE ---
    async addTrainingContent() {
        const content = document.getElementById('post-content-input').value;
        const imageUrl = document.getElementById('post-image-url').value;
        const postType = document.getElementById('post-type-select').value;

        if (!content.trim()) {
            this.showNotification('Post text cannot be empty.', 'error');
            return;
        }

        this.showNotification('Adding content to AI memory...', 'info');

        try {
            const response = await fetch(`${this.apiBase}/brand-voice/train`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: this.currentUser,
                    content: content,
                    image_url: imageUrl,
                    post_type: postType
                }),
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            this.showNotification('Successfully added content!', 'success');
            document.getElementById('train-voice-form').reset();
        } catch (error) {
            this.showNotification(`Error: ${error.message}`, 'error');
        }
    }

    // --- CONTENT GENERATION ---
    async generateContent() {
        const topic = document.getElementById('content-topic').value;
        // --- THIS IS THE FIX ---
        const contentType = document.getElementById('content-type-select').value;
        // ----------------------
        const resultsDiv = document.getElementById('content-results');
        
        resultsDiv.innerHTML = `<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div><p class="mt-2 text-gray-500">Generating ideas...</p></div>`;

        try {
            // --- THIS IS ALSO THE FIX ---
            // The parameter name must match what the backend route expects ('type').
            const response = await fetch(`${this.apiBase}/learning/content-recommendations?topic=${encodeURIComponent(topic)}&type=${encodeURIComponent(contentType)}`);
            // --------------------------
            
            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            this.displayContentResults(result.recommendations);
        } catch (error) {
            resultsDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-md"><strong>Error:</strong> ${error.message}</div>`;
        }
    }

    displayContentResults(recommendations) {
        const resultsDiv = document.getElementById('content-results');
        if (!recommendations || recommendations.length === 0) {
            resultsDiv.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-700 rounded-md">No recommendations generated. Try a different topic or add more training data.</div>`;
            return;
        }

        resultsDiv.innerHTML = recommendations.map(rec => `
            <div class="recommendation-card">
                <p>${rec.content.replace(/\n/g, '  
')}</p>
                <div class="seo-analysis">
                    <strong>SEO Score: ${rec.seo_score || 'N/A'}</strong>
                    <ul>${(rec.seo_recommendations || []).map(r => `<li>${r}</li>`).join('')}</ul>
                </div>
                <button class="create-ab-test-btn" data-content='${JSON.stringify(rec)}'>Create A/B Test</button>
            </div>
        `).join('');
    }

    // --- A/B TESTING ---
    handleCreateABTest(button) {
        const contentData = JSON.parse(button.dataset.content);
        if (window.abTestingModule) {
            window.abTestingModule.createTest(`A/B Test for "${contentData.focus}"`, contentData);
        } else {
            this.showNotification('A/B testing module not loaded.', 'error');
        }
    }

    // --- UTILITIES ---
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const colors = {
            success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500'
        };
        notification.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 ${colors[type]}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    window.socialMediaManager = new SocialMediaAutomation();
});
